<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöÄ AI Meeting Recorder</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2.2em;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
    }
    .chunk-duration {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    input[type="range"] {
      width: 100%;
      margin-top: 10px;
    }
    .status {
      text-align: center;
      font-size: 1.1em;
      font-weight: 600;
      padding: 15px;
      margin: 20px 0;
      border-radius: 10px;
      background: #e8f5e8;
      color: #2d5016;
      transition: all 0.3s;
    }
    .status.recording {
      background: #ffe8e8;
      color: #d63384;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    .controls {
      display: flex;
      gap: 10px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    button {
      flex: 1;
      min-width: 120px;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .start-btn {
      background: #28a745;
      color: white;
    }
    .start-btn:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
    }
    .pause-btn {
      background: #ffc107;
      color: #212529;
    }
    .pause-btn:hover:not(:disabled) {
      background: #e0a800;
      transform: translateY(-2px);
    }
    .stop-btn {
      background: #dc3545;
      color: white;
    }
    .stop-btn:hover:not(:disabled) {
      background: #c82333;
      transform: translateY(-2px);
    }
    .clear-btn {
      background: #6c757d;
      color: white;
    }
    .clear-btn:hover:not(:disabled) {
      background: #5a6268;
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .log-section {
      margin-top: 30px;
    }
    .section-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 20px;
      height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .debug-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ AI Meeting Recorder</h1>

    <div class="input-group">
      <label for="meetingName">–ù–∞–∑–≤–∞ –∑—É—Å—Ç—Ä—ñ—á—ñ:</label>
      <input type="text" id="meetingName" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∑—É—Å—Ç—Ä—ñ—á—ñ">
    </div>

    <div class="input-group">
      <label for="cod">–ö–æ–¥ (–¥–ª—è –Ω–∞–∑–≤–∏ —Ñ–∞–π–ª—É):</label>
      <input type="number" id="cod" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 123">
    </div>

    <div class="chunk-duration">
      <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —á–∞—Å—Ç–∏–Ω–∏: <span id="durationValue">240</span> —Å–µ–∫—É–Ω–¥</label><br>
      <input type="range" id="chunkDuration" min="10" max="300" value="240" step="5">
    </div>

    <div class="debug-info" id="debugInfo">
      <strong>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—ñ–¥—Ç—Ä–∏–º–∫—É:</strong><br>
      <span id="supportInfo">–ü–µ—Ä–µ–≤—ñ—Ä—è—é –ø—ñ–¥—Ç—Ä–∏–º–∫—É –±—Ä–∞—É–∑–µ—Ä–∞...</span>
    </div>

    <div class="status" id="status">‚ñ∂Ô∏è –ì–æ—Ç–æ–≤–∏–π –¥–æ –∑–∞–ø–∏—Å—É</div>

    <div class="controls">
      <button class="start-btn" id="startBtn">üé§ –°—Ç–∞—Ä—Ç</button>
      <button class="pause-btn" id="pauseBtn">‚è∏ –ü–∞—É–∑–∞</button>
      <button class="stop-btn" id="stopBtn" disabled>üö© –°—Ç–æ–ø</button>
      <button class="clear-btn" id="clearLogsBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥–∏</button>
    </div>

    <div class="log-section">
      <div class="section-title">üìú –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</div>
      <div class="log" id="log">–ì–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏...</div>
    </div>
  </div>

  <script>
    const FIXED_BOT_TOKEN = "7559425067:AAEoI0api5HvyDGOulacrGcqNHAT0fqwHcE";
    const FIXED_CHAT_ID = "-1002576413834";

    class AudioRecorderApp {
      constructor() {
        this.isRecording = false;
        this.mediaRecorder = null;
        this.chunkCounter = 0;
        this.endSession = false;
        this.audioStream = null;
        this.recordedChunks = [];
        this.initializeElements();
        this.checkBrowserSupport();
        this.setupEventListeners();
      }

      initializeElements() {
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.pauseBtn = document.getElementById('pauseBtn');
        this.status = document.getElementById('status');
        this.log = document.getElementById('log');
        this.chunkDuration = document.getElementById('chunkDuration');
        this.durationValue = document.getElementById('durationValue');
        this.clearLogsBtn = document.getElementById('clearLogsBtn');
        this.meetingNameInput = document.getElementById('meetingName');
        this.codInput = document.getElementById('cod');
        this.supportInfo = document.getElementById('supportInfo');
      }

      checkBrowserSupport() {
        let supportText = '';
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ MediaRecorder
        if (!window.MediaRecorder) {
          supportText += '‚ùå MediaRecorder –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è\n';
        } else {
          supportText += '‚úÖ MediaRecorder –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è\n';
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          supportText += '‚ùå getUserMedia –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è\n';
        } else {
          supportText += '‚úÖ getUserMedia –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è\n';
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ñ–æ—Ä–º–∞—Ç—ñ–≤
        const mimeTypes = [
          'audio/webm',
          'audio/webm;codecs=opus',
          'audio/webm;codecs=vorbis',
          'audio/mp4',
          'audio/ogg;codecs=opus'
        ];

        supportText += '\n–ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏:\n';
        mimeTypes.forEach(type => {
          if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
            supportText += `‚úÖ ${type}\n`;
          } else {
            supportText += `‚ùå ${type}\n`;
          }
        });

        this.supportInfo.textContent = supportText;
      }

      setupEventListeners() {
        this.startBtn.addEventListener('click', () => this.startRecording());
        this.stopBtn.addEventListener('click', () => this.stopRecording());
        this.pauseBtn.addEventListener('click', () => this.pauseRecording());
        this.chunkDuration.addEventListener('input', (e) => {
          this.durationValue.textContent = e.target.value;
        });
        this.clearLogsBtn.addEventListener('click', () => {
          this.log.textContent = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω–æ...\n';
        });
      }

      logMessage(message) {
        const timestamp = new Date().toLocaleTimeString('uk-UA');
        this.log.textContent += `\n[${timestamp}] ${message}`;
        this.log.scrollTop = this.log.scrollHeight;
        console.log(`[${timestamp}] ${message}`);
      }

      getSupportedMimeType() {
        const mimeTypes = [
          'audio/webm;codecs=opus',
          'audio/webm',
          'audio/mp4',
          'audio/ogg;codecs=opus'
        ];

        for (const type of mimeTypes) {
          if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
            return type;
          }
        }
        return 'audio/webm'; // fallback
      }

      async startRecording() {
        try {
          // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π stream —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
          if (this.audioStream) {
            this.audioStream.getTracks().forEach(track => track.stop());
          }

          // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤–∏–π stream
          this.audioStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            }
          });

          this.isRecording = true;
          this.endSession = false;
          this.chunkCounter = 0;
          this.startBtn.disabled = true;
          this.stopBtn.disabled = false;
          this.pauseBtn.disabled = false;
          this.status.textContent = 'üî¥ –ó–∞–ø–∏—Å –∞–∫—Ç–∏–≤–Ω–∏–π...';
          this.status.classList.add('recording');
          this.logMessage('üî¥ –ó–∞–ø–∏—Å —Ä–æ–∑–ø–æ—á–∞—Ç–æ...');
          
          this.startChunkRecording();
        } catch (error) {
          this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞: ${error.message}`);
          console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
        }
      }

      pauseRecording() {
        this.isRecording = false;
        this.logMessage('‚è∏ –ü–∞—É–∑–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞');
        
        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
          this.mediaRecorder.stop();
        }
        
        this.startBtn.disabled = false;
        this.stopBtn.disabled = false;
        this.pauseBtn.disabled = false;
        this.status.textContent = '‚è∏ –ó–∞–ø–∏—Å –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ';
        this.status.classList.remove('recording');
      }

      stopRecording() {
        this.isRecording = false;
        this.endSession = true;
        
        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
          this.mediaRecorder.stop();
        }
        
        // –ó—É–ø–∏–Ω—è—î–º–æ –≤—Å—ñ –∞—É–¥—ñ–æ —Ç—Ä–µ–∫–∏
        if (this.audioStream) {
          this.audioStream.getTracks().forEach(track => track.stop());
          this.audioStream = null;
        }
        
        this.startBtn.disabled = false;
        this.stopBtn.disabled = true;
        this.pauseBtn.disabled = true;
        this.status.textContent = '‚èπÔ∏è –ó–∞–ø–∏—Å –∑—É–ø–∏–Ω–µ–Ω–æ';
        this.status.classList.remove('recording');
        this.logMessage('‚èπÔ∏è –ó–∞–ø–∏—Å –∑—É–ø–∏–Ω–µ–Ω–æ –∑ –ø–æ–∑–Ω–∞—á–∫–æ—é END');
      }

      startChunkRecording() {
        if (!this.isRecording || !this.audioStream) return;

        this.recordedChunks = [];
        const mimeType = this.getSupportedMimeType();
        
        try {
          this.mediaRecorder = new MediaRecorder(this.audioStream, {
            mimeType: mimeType
          });
        } catch (error) {
          this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è MediaRecorder: ${error.message}`);
          // –°–ø—Ä–æ–±—É—î–º–æ –±–µ–∑ mimeType
          try {
            this.mediaRecorder = new MediaRecorder(this.audioStream);
          } catch (fallbackError) {
            this.logMessage(`‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ MediaRecorder: ${fallbackError.message}`);
            return;
          }
        }

        this.mediaRecorder.ondataavailable = (event) => {
          console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ:', event.data.size, '–±–∞–π—Ç');
          if (event.data && event.data.size > 0) {
            this.recordedChunks.push(event.data);
          }
        };

        this.mediaRecorder.onstop = async () => {
          console.log('MediaRecorder –∑—É–ø–∏–Ω–µ–Ω–æ. –ö—ñ–ª—å–∫—ñ—Å—Ç—å —á–∞—Å—Ç–∏–Ω:', this.recordedChunks.length);
          
          if (this.recordedChunks.length === 0) {
            this.logMessage('‚ùå –ù–µ–º–∞—î –∑–∞–ø–∏—Å–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö');
            if (this.isRecording) {
              setTimeout(() => this.startChunkRecording(), 500);
            }
            return;
          }

          const totalSize = this.recordedChunks.reduce((sum, chunk) => sum + chunk.size, 0);
          console.log('–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä:', totalSize, '–±–∞–π—Ç');
          
          if (totalSize === 0) {
            this.logMessage('‚ùå –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –∞—É–¥—ñ–æ = 0 –±–∞–π—Ç');
            if (this.isRecording) {
              setTimeout(() => this.startChunkRecording(), 500);
            }
            return;
          }

          const audioBlob = new Blob(this.recordedChunks, { 
            type: this.mediaRecorder.mimeType || 'audio/webm' 
          });
          
          const timestamp = Date.now();
          this.logMessage(`‚è≥ –ì–æ—Ç—É—é –∞—É–¥—ñ–æ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (${audioBlob.size} –±–∞–π—Ç)...`);
          
          try {
            await this.sendAudioToTelegram(audioBlob, timestamp);
          } catch (error) {
            this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ${error.message}`);
          }

          // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –∑–∞–ø–∏—Å –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏
          if (this.isRecording) {
            setTimeout(() => this.startChunkRecording(), 500);
          }
        };

        this.mediaRecorder.onerror = (event) => {
          this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ MediaRecorder: ${event.error}`);
          console.error('–ü–æ–º–∏–ª–∫–∞ MediaRecorder:', event.error);
        };

        this.mediaRecorder.onstart = () => {
          this.logMessage(`üéµ –†–æ–∑–ø–æ—á–∞—Ç–æ –∑–∞–ø–∏—Å —á–∞—Å—Ç–∏–Ω–∏ ${this.chunkCounter + 1} (${this.chunkDuration.value}—Å)...`);
        };

        try {
          this.mediaRecorder.start(1000); // –ó–∞–ø–∏—Ç—É—î–º–æ –¥–∞–Ω—ñ –∫–æ–∂–Ω—É —Å–µ–∫—É–Ω–¥—É
          this.chunkCounter++;
          
          // –ó—É–ø–∏–Ω—è—î–º–æ –∑–∞–ø–∏—Å —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ–∫—É–Ω–¥
          setTimeout(() => {
            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
              this.mediaRecorder.stop();
            }
          }, parseInt(this.chunkDuration.value) * 1000);
          
        } catch (error) {
          this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É MediaRecorder: ${error.message}`);
          console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É MediaRecorder:', error);
        }
      }

      async sendAudioToTelegram(audioBlob, timestamp) {
        if (audioBlob.size === 0) {
          this.logMessage('‚ùå –ê—É–¥—ñ–æ—Ñ–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π, –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–∫–∞—Å–æ–≤–∞–Ω–∞.');
          return;
        }

        const formData = new FormData();
        const baseName = this.meetingNameInput.value.trim() || 'audio';
        const cod = this.codInput.value.trim();
        
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ MIME —Ç–∏–ø—É
        const mimeType = audioBlob.type || 'audio/webm';
        let extension = '.webm';
        if (mimeType.includes('mp4')) extension = '.mp4';
        else if (mimeType.includes('ogg')) extension = '.ogg';
        
        const filename = `${baseName.replace(/[^a-zA-Z0-9_\-\u0400-\u04FF]/g, '#')}_${timestamp}${this.endSession ? '_END' : ''}${cod ? '_' + cod : ''}${extension}`;
        
        formData.append('document', audioBlob, filename);
        formData.append('chat_id', FIXED_CHAT_ID);
        
        const url = `https://api.telegram.org/bot${FIXED_BOT_TOKEN}/sendDocument`;

        try {
          this.logMessage(`üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é ${filename} –≤ Telegram (${audioBlob.size} –±–∞–π—Ç)...`);
          
          const response = await fetch(url, {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          
          if (response.ok && result.ok) {
            this.logMessage(`‚úÖ –ê—É–¥—ñ–æ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${filename}`);
          } else {
            this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ${result.description || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'}`);
            console.error('–ü–æ–º–∏–ª–∫–∞ Telegram API:', result);
          }
        } catch (error) {
          this.logMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: ${error.message}`);
          console.error('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ:', error);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new AudioRecorderApp();
    });
  </script>
</body>
</html>
